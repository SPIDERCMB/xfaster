<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>xfaster.xfaster_exec &mdash; xfaster 1.1.1 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            xfaster
          </a>
              <div class="version">
                1.1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithm.html">Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/XFaster_Tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xfaster</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">xfaster.xfaster_exec</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for xfaster.xfaster_exec</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">xfaster_class</span> <span class="k">as</span> <span class="n">xfc</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">batch_tools</span> <span class="k">as</span> <span class="n">bt</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">parse_tools</span> <span class="k">as</span> <span class="n">pt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;xfaster_run&quot;</span><span class="p">,</span>
    <span class="s2">&quot;xfaster_parse&quot;</span><span class="p">,</span>
    <span class="s2">&quot;xfaster_submit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;xfaster_dump&quot;</span><span class="p">,</span>
    <span class="s2">&quot;xfaster_main&quot;</span><span class="p">,</span>
    <span class="s2">&quot;XFasterJobGroup&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="xfaster_run"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.xfaster_run">[docs]</a><span class="k">def</span> <span class="nf">xfaster_run</span><span class="p">(</span>
    <span class="c1"># common options</span>
    <span class="n">config</span><span class="o">=</span><span class="s2">&quot;config_example.ini&quot;</span><span class="p">,</span>
    <span class="n">output_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="s2">&quot;notice&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">alm_pixel_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">alm_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">add_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># file options</span>
    <span class="n">data_root</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">data_subset</span><span class="o">=</span><span class="s2">&quot;full/*0&quot;</span><span class="p">,</span>
    <span class="n">data_root2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_subset2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="c1"># binning options</span>
    <span class="n">lmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">lmax</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">pol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">pol_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">tbeb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bin_width</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">weighted_bins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">residual_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">bin_width_res</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">res_specs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">foreground_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">beta_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bin_width_fg</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">lmin_fg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lmax_fg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="c1"># beam and kernel options</span>
    <span class="n">pixwin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">mask_type</span><span class="o">=</span><span class="s2">&quot;rectangle&quot;</span><span class="p">,</span>
    <span class="n">window_lmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">apply_gcorr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">reload_gcorr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">gcorr_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="c1"># sim ensemble options</span>
    <span class="n">signal_type</span><span class="o">=</span><span class="s2">&quot;synfast&quot;</span><span class="p">,</span>
    <span class="n">signal_subset</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="n">signal_transfer_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">noise_type</span><span class="o">=</span><span class="s2">&quot;stationary&quot;</span><span class="p">,</span>
    <span class="n">noise_subset</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="n">qb_file_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="c1"># shape spectrum options</span>
    <span class="n">signal_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">signal_transfer_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">foreground_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">freq_ref</span><span class="o">=</span><span class="mf">359.7</span><span class="p">,</span>
    <span class="n">beta_ref</span><span class="o">=</span><span class="mf">1.54</span><span class="p">,</span>
    <span class="c1"># data options</span>
    <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span>
    <span class="n">template_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">template_noise_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">template_alpha_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">template_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reference_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ensemble_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ensemble_median</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">sim_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">sim_data_components</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="s2">&quot;foreground&quot;</span><span class="p">],</span>
    <span class="n">sim_index_signal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sim_index_noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sim_index_foreground</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sim_index_default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">num_sims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">signal_type_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sim_data_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">noise_type_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">qb_file_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">foreground_type_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">template_type_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">template_alpha_tags_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">template_alpha_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">save_sim_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># spectrum estimation options</span>
    <span class="n">multi_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">bandpower_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">converge_criteria</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
    <span class="n">cond_noise</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
    <span class="n">cond_criteria</span><span class="o">=</span><span class="mf">5e3</span><span class="p">,</span>
    <span class="n">iter_max</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">save_iters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">return_cls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">qb_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">fix_bb_transfer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">null_first_cmb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">delta_beta_prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">like_profiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">like_profile_sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
    <span class="n">like_profile_points</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="c1"># likelihood options</span>
    <span class="n">likelihood</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">mcmc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">mcmc_walkers</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">like_converge_criteria</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">like_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">like_lmin</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span>
    <span class="n">like_lmax</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
    <span class="n">like_r_specs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;EE&quot;</span><span class="p">,</span> <span class="s2">&quot;BB&quot;</span><span class="p">],</span>
    <span class="n">like_template_specs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;EE&quot;</span><span class="p">,</span> <span class="s2">&quot;BB&quot;</span><span class="p">,</span> <span class="s2">&quot;EB&quot;</span><span class="p">],</span>
    <span class="n">like_alpha_tags</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">r_prior</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
    <span class="n">res_prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">like_beam_tags</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">beam_prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function for running the XFaster algorithm.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    config : str</span>
<span class="sd">        Configuration file. If path doesn&#39;t exist, assumed</span>
<span class="sd">        to be in xfaster/config/&lt;config&gt;</span>
<span class="sd">    output_root : str</span>
<span class="sd">        Directory in which to store output files</span>
<span class="sd">    output_tag : str</span>
<span class="sd">        File tag for output files</span>
<span class="sd">    verbose : str</span>
<span class="sd">        Logging verbosity level.  Can be one of [&#39;critical&#39;, &#39;error&#39;, &#39;warning&#39;,</span>
<span class="sd">        &#39;notice&#39;, &#39;info&#39;, &#39;debug&#39;, all&#39;].</span>
<span class="sd">    debug : bool</span>
<span class="sd">        Store extra data in output files for debugging.</span>
<span class="sd">    checkpoint : str</span>
<span class="sd">        If supplied, re-compute all steps of the algorithm from this point</span>
<span class="sd">        forward.  Valid checkpoints are {checkpoints}.</span>
<span class="sd">    alm_pixel_weights : bool</span>
<span class="sd">        If True, set the ``use_pixel_weights`` option to True when computing map</span>
<span class="sd">        Alms using ``healpy.map2alm``.  If False, sets the ``use_weights``</span>
<span class="sd">        option to True instead.  Note: pixel weights ensure accurate Alm</span>
<span class="sd">        computation, but can only be used for analyses where ``lmax &lt; 1.5 *</span>
<span class="sd">        nside``.</span>
<span class="sd">    alm_iter : int</span>
<span class="sd">        If given, set the ``iter`` option to the given value when computing map</span>
<span class="sd">        Alms using ``healpy.map2alm``.  Using more iterations improves the</span>
<span class="sd">        accuracy of the output Alms.  If not set, uses the default number of</span>
<span class="sd">        iterations (3) as defined in healpy.  Ignored if ``alm_pixel_weights``</span>
<span class="sd">        is True.</span>
<span class="sd">    add_log : bool</span>
<span class="sd">        If True, write log output to a file instead of to STDOUT.</span>
<span class="sd">        The log will be in ``&lt;output_root&gt;/xfaster-&lt;output_tag&gt;.log``.</span>
<span class="sd">        This option is useful for logging to file for jobs that</span>
<span class="sd">        are run directly (rather than submitted).</span>
<span class="sd">    data_root : str</span>
<span class="sd">        Root directory where all input files are stored</span>
<span class="sd">    data_subset : str</span>
<span class="sd">        The subset of the data maps to include from each data split.  Must be a</span>
<span class="sd">        glob-parseable string.  Include multiple tags as a comma-delimited</span>
<span class="sd">        sequence enclosed in double quotes.</span>
<span class="sd">    data_root2 : str</span>
<span class="sd">        Path for second set of maps for null test. If set, XFaster performs a</span>
<span class="sd">        null test between ``data_root`` and ``data_root2``.</span>
<span class="sd">    data_subset2 : str</span>
<span class="sd">        The subset of the data maps to include from each data split for the</span>
<span class="sd">        second half of a null split.</span>
<span class="sd">    lmin : int</span>
<span class="sd">       Minimum ell at which to start the lowest bin of the output spectra.</span>
<span class="sd">    lmax : int</span>
<span class="sd">        Maximum ell for which to compute spectra.</span>
<span class="sd">    pol : bool</span>
<span class="sd">        If True, polarization spectra are computed.</span>
<span class="sd">    pol_mask : bool</span>
<span class="sd">        If True, a separate mask is applied for Q/U maps.</span>
<span class="sd">    tbeb : bool</span>
<span class="sd">        If True, compute TB/EB spectra.</span>
<span class="sd">    bin_width : int or array_like of 6 ints</span>
<span class="sd">        Width of each ell bin for each of the six output spectra</span>
<span class="sd">        (TT, EE, BB, TE, EB, TB).  EE/BB bins should be the same</span>
<span class="sd">        in order to handle mixing correctly.</span>
<span class="sd">    weighted_bins : bool</span>
<span class="sd">        If True, use an lfac-weighted binning operator to construct Cbls.</span>
<span class="sd">        By default, a flat binning operator is used.</span>
<span class="sd">    residual_fit : bool</span>
<span class="sd">        If True, include noise residual bins in the estimator.</span>
<span class="sd">    bin_width_res : int or array_like of ints</span>
<span class="sd">        Width of each residual spectrum bin.  If a scalar, the same width is</span>
<span class="sd">        applied to all spectra for all cross spectra.  Otherwise, must be a list</span>
<span class="sd">        of up to nspec * nmaps elements, listing bin widths for each of the</span>
<span class="sd">        spectra in ``res_specs`` in order, then ordered by map.</span>
<span class="sd">    res_specs : list of strings</span>
<span class="sd">        Spectra to include in noise residual fitting.  List values can be any of</span>
<span class="sd">        the cross spectra TT, EE, BB, TE, EB, TB, or EEBB for fitting EE and BB</span>
<span class="sd">        residuals simultaneously.  If not supplied, this defaults to EEBB for</span>
<span class="sd">        polarized maps, or TT for unpolarized maps.</span>
<span class="sd">    foreground_fit : bool</span>
<span class="sd">        Include foreground residuals in the estimator.</span>
<span class="sd">    beta_fit : bool</span>
<span class="sd">        If True, include a fit for ``delta_beta`` in the estimator.  Otherwise,</span>
<span class="sd">        only fit for foreground amplitudes.</span>
<span class="sd">    bin_width_fg : int or array_like of 6 ints</span>
<span class="sd">        Width of each ell bin for each of the six output foreground spectra</span>
<span class="sd">        (TT, EE, BB, TE, EB, TB).  EE/BB bins should be the same</span>
<span class="sd">        in order to handle mixing correctly.</span>
<span class="sd">    lmin_fg : int</span>
<span class="sd">        Minimum ell to use for defining foreground bins.  If not set, defaults</span>
<span class="sd">        to ``lmin``.</span>
<span class="sd">    lmax_fg : int</span>
<span class="sd">        Maximum ell to use for defining foreground bins.  If not set, defaults</span>
<span class="sd">        to ``lmax``.</span>
<span class="sd">    pixwin : bool</span>
<span class="sd">        If True, apply pixel window functions to beam windows.</span>
<span class="sd">    mask_type : str</span>
<span class="sd">        The variant of mask to use</span>
<span class="sd">    window_lmax : int</span>
<span class="sd">        The size of the window used in computing the mask kernels</span>
<span class="sd">    apply_gcorr : bool</span>
<span class="sd">        If True, a correction factor is applied to the g (mode counting)</span>
<span class="sd">        matrix.  The correction factor should have been pre-computed</span>
<span class="sd">        for each map tag.</span>
<span class="sd">    reload_gcorr : bool</span>
<span class="sd">        If True, reload the gcorr file from the masks directory. Useful when</span>
<span class="sd">        iteratively solving for the correction terms.</span>
<span class="sd">    gcorr_file : str</span>
<span class="sd">        If not None, path to gcorr file. Otherwise, use file labeled</span>
<span class="sd">        mask_map_&lt;tag&gt;_gcorr.npy in mask directory for signal, or</span>
<span class="sd">        mask_map_&lt;tag&gt;_gcorr_null.npy for nulls.</span>
<span class="sd">    signal_type : str</span>
<span class="sd">        The variant of signal sims to use for the signal component of the</span>
<span class="sd">        covariance model.</span>
<span class="sd">    signal_subset : str</span>
<span class="sd">        The subset of the signal sims to include.  Must be a glob-parseable</span>
<span class="sd">        string.</span>
<span class="sd">    signal_transfer_type : str</span>
<span class="sd">        The variant of signal sims to use for computing the transfer function.</span>
<span class="sd">        If not set, defaults to ``signal_type``.</span>
<span class="sd">    noise_type : str</span>
<span class="sd">        The variant of noise sims to use for the noise component of the</span>
<span class="sd">        covariance model.</span>
<span class="sd">    noise_subset : str</span>
<span class="sd">        The subset of the noise sims to include.  Must be a glob-parseable</span>
<span class="sd">        string.</span>
<span class="sd">    qb_file_sim : str</span>
<span class="sd">        If not None, pointer to a bandpowers.npz file in the output directory,</span>
<span class="sd">        to correct the noise ensemble by an appropriate set of residual ``qb``</span>
<span class="sd">        values.</span>
<span class="sd">    signal_spec : str</span>
<span class="sd">        The spectrum data file to use for estimating signal component</span>
<span class="sd">        bandpowers.  If not supplied, will search for</span>
<span class="sd">        ``spec_signal_&lt;signal_type&gt;.dat`` in the signal sim directory.</span>
<span class="sd">    signal_transfer_spec : str</span>
<span class="sd">        The spectrum data file used to generate signal sims for computing the</span>
<span class="sd">        signal transfer function.  If not supplied, will search for</span>
<span class="sd">        ``spec_signal_&lt;signal_transfer_type&gt;.dat`` in the transfer signal sim</span>
<span class="sd">        directory.</span>
<span class="sd">    foreground_spec : string</span>
<span class="sd">        The spectrum data file to use for estimating foreground component</span>
<span class="sd">        bandpowers.  If not supplied, use a simple power law model for dust</span>
<span class="sd">        foregrounds.</span>
<span class="sd">    model_r : float</span>
<span class="sd">        The ``r`` value to use to compute a spectrum for estimating bandpowers.</span>
<span class="sd">        Overrides ``signal_spec``.</span>
<span class="sd">    freq_ref : float</span>
<span class="sd">        In GHz, reference frequency for dust model. Dust bandpowers output</span>
<span class="sd">        will be at this reference frequency.</span>
<span class="sd">    beta_ref : float</span>
<span class="sd">        The spectral index of the dust model. This is a fixed value, with</span>
<span class="sd">        an additive deviation from this value fit for in foreground fitting</span>
<span class="sd">        mode.</span>
<span class="sd">    data_type : str</span>
<span class="sd">        The data type to use</span>
<span class="sd">    template_type : str</span>
<span class="sd">        Tag for directory (templates_&lt;template_type&gt;) containing templates</span>
<span class="sd">        (e.g. a foreground model) to be scaled by a scalar value per</span>
<span class="sd">        map tag and subtracted from the data. The directory is assumed</span>
<span class="sd">        to contain reference1 and reference2 subdirectories, each</span>
<span class="sd">        containing one template per map tag.</span>
<span class="sd">    template_noise_type : string</span>
<span class="sd">        Tag for directory containing template noise sims to be averaged and</span>
<span class="sd">        scaled similarly to the templates themselves.  These averaged sims are</span>
<span class="sd">        used to debias template cross spectra due to correlations in the way the</span>
<span class="sd">        noise ensembles are constructed.  Typically, this would be a noise model</span>
<span class="sd">        based on the Planck FFP10 ensemble for each half-mission foreground</span>
<span class="sd">        template.</span>
<span class="sd">    template_alpha_tags : list of strings</span>
<span class="sd">        List of map tags from which foreground template maps should be</span>
<span class="sd">        subtracted.  These should be the original map tags, not</span>
<span class="sd">        those generated for chunk sets.</span>
<span class="sd">    template_alpha : list of floats</span>
<span class="sd">        Scalar to be applied to template map for subtraction from each of the</span>
<span class="sd">        data with tags in the list ``template_alpha_tags``.</span>
<span class="sd">    reference_type : string</span>
<span class="sd">        Tag for directory containing reobserved reference signals, to be</span>
<span class="sd">        subtracted from each data map.  The reference signal maps should be two</span>
<span class="sd">        datasets with uncorrelated noise, such as Planck half-mission maps.</span>
<span class="sd">        This option is used for removing expected signal residuals from null</span>
<span class="sd">        tests.</span>
<span class="sd">    ensemble_mean : bool</span>
<span class="sd">        If True, substitute S+N ensemble means for Cls to test for bias</span>
<span class="sd">        in the estimator.</span>
<span class="sd">    ensemble_median : bool</span>
<span class="sd">        If True, substitute S+N ensemble median for Cls to test for bias</span>
<span class="sd">        in the estimator.</span>
<span class="sd">    sim_data : bool</span>
<span class="sd">        If True, construct simulated data spectra using the options below.</span>
<span class="sd">    sim_data_components : list of strings</span>
<span class="sd">        List of components to include in simulated data.  May include signal,</span>
<span class="sd">        noise, foreground or template components.</span>
<span class="sd">    sim_index_signal : int</span>
<span class="sd">        Sim index to use for the signal component that is included in</span>
<span class="sd">        ``sim_data_components``.  If None or &lt; 0, takes the value of</span>
<span class="sd">        ``sim_index_default``.</span>
<span class="sd">    sim_index_noise : int</span>
<span class="sd">        Sim index to use for the noise component that is included in</span>
<span class="sd">        ``sim_data_components``.  If None or &lt; 0, takes the value of</span>
<span class="sd">        ``sim_index_default``.</span>
<span class="sd">    sim_index_foreground : int</span>
<span class="sd">        Sim index to use for the foreground component that is included in</span>
<span class="sd">        ``sim_data_components``.  If None or &lt; 0, takes the value of</span>
<span class="sd">        ``sim_index_default``.</span>
<span class="sd">    sim_index_default : int</span>
<span class="sd">        Default sim index to use for any component with index &lt; 0 or None</span>
<span class="sd">        in ``sim_index_&lt;comp&gt;``.</span>
<span class="sd">    num_sims : int</span>
<span class="sd">        If &gt; 1, repeat the data, bandpowers and likelihood checkpoints this many</span>
<span class="sd">        times, incrementing the value of ``sim_index_default`` by 1 each time,</span>
<span class="sd">        starting from the input value.  Only used if ``sim_data`` is True.</span>
<span class="sd">        All other options remain the same for each iteration.</span>
<span class="sd">    signal_type_sim : str</span>
<span class="sd">        The variant of signal sims to use for sim_index data maps.</span>
<span class="sd">        This enables having a different noise sim ensemble to use for</span>
<span class="sd">        sim_index run than the ensemble from which the signal is computed.</span>
<span class="sd">    sim_data_r : float</span>
<span class="sd">        If not None, construct the signal component of the simulated data by</span>
<span class="sd">        selecting the appropriate index from an ensemble of scalar and tensor</span>
<span class="sd">        maps, such that the signal component is ``scalar + r * tensor``.  This</span>
<span class="sd">        assumes that the tensor simulations are constructed with ``nt=0``, so</span>
<span class="sd">        that the linear relationship holds.</span>
<span class="sd">    noise_type_sim : str</span>
<span class="sd">        The variant of noise sims to use for sim_index fake data map.</span>
<span class="sd">        This enables having a different noise sim ensemble to use for</span>
<span class="sd">        sim_index run than the ensemble from which the noise is computed.</span>
<span class="sd">    qb_file_data : str</span>
<span class="sd">        If not None, pointer to a bandpowers.npz file in the output directory,</span>
<span class="sd">        to correct the noise component of the simulated data by an appropriate</span>
<span class="sd">        set of residual ``qb`` values.</span>
<span class="sd">    foreground_type_sim : str</span>
<span class="sd">        Tag for directory (foreground_&lt;foreground_type_sim&gt;) where foreground</span>
<span class="sd">        sims are stored that should be added to the signal and noise sims</span>
<span class="sd">        when running in sim_index mode.</span>
<span class="sd">    template_type_sim : string</span>
<span class="sd">        Tag for directory containing foreground templates, to be scaled by a</span>
<span class="sd">        scalar value per map tag and added to the simulated data.  The directory</span>
<span class="sd">        contains one template per map tag.</span>
<span class="sd">    template_alpha_tags_sim : list of str</span>
<span class="sd">        List of map tags to which foreground template maps should be added, if</span>
<span class="sd">        the template component is included in ``sim_data_components``.  These</span>
<span class="sd">        should be the original map tags, not those generated for chunk sets.</span>
<span class="sd">        If None, use the same values as `template_alpha_tags`.</span>
<span class="sd">    template_alpha_sim : list of floats</span>
<span class="sd">        Scalar to be applied to template map for addition to each of the</span>
<span class="sd">        simulated data maps with tags in the list ``template_alpha_tags``.</span>
<span class="sd">        If None, use the same values as `template_alpha`.</span>
<span class="sd">    save_sim_data : bool</span>
<span class="sd">        If True, save data_xcorr file to disk for simulated data.</span>
<span class="sd">    multi_map : bool</span>
<span class="sd">        If True, compute all cross-spectra between maps</span>
<span class="sd">    bandpower_tag : str</span>
<span class="sd">        Tag to append to bandpowers output file</span>
<span class="sd">    converge_criteria : float</span>
<span class="sd">        The maximum fractional change in qb to signal convergence and</span>
<span class="sd">        end iteration</span>
<span class="sd">    cond_noise : float</span>
<span class="sd">        The level of regularizing noise to add to EE and BB diagonals.</span>
<span class="sd">    cond_criteria : float</span>
<span class="sd">        Threshold on covariance condition number. Above this, regularizing noise</span>
<span class="sd">        will be added to covariance to condition it.</span>
<span class="sd">    iter_max : int</span>
<span class="sd">        The maximum number of iterations</span>
<span class="sd">    save_iters : bool</span>
<span class="sd">        If True, store the output of each Fisher iteration, in addition to</span>
<span class="sd">        the end result.</span>
<span class="sd">    return_cls : bool</span>
<span class="sd">        If True, return C_l spectrum rather than the D_l spectrum</span>
<span class="sd">    qb_only : bool</span>
<span class="sd">        If True, do not compute signal window functions or C_l or D_l bandpowers</span>
<span class="sd">    fix_bb_transfer : bool</span>
<span class="sd">        If True, after transfer functions have been calculated, impose that the</span>
<span class="sd">        BB transfer function is exactly equal to the EE transfer function.</span>
<span class="sd">    null_first_cmb : bool</span>
<span class="sd">        If True, keep first CMB bandpowers fixed to input shape (qb=1).</span>
<span class="sd">    delta_beta_prior : float</span>
<span class="sd">        The width of the prior on the additive change from beta_ref. If you</span>
<span class="sd">        don&#39;t want the code to fit for a spectral index different</span>
<span class="sd">        from beta_ref, set this to be None.</span>
<span class="sd">    like_profiles : bool</span>
<span class="sd">        If True, compute profile likelihoods for each qb, leaving all</span>
<span class="sd">        others fixed at their maximum likelihood values.  Profiles are</span>
<span class="sd">        computed over a range +/--sigma as estimated from the diagonals</span>
<span class="sd">        of the inverse Fisher matrix.</span>
<span class="sd">    like_profile_sigma : float</span>
<span class="sd">        Range in units of 1sigma over which to compute profile likelihoods</span>
<span class="sd">    like_profile_points : int</span>
<span class="sd">        Number of points to sample along the likelihood profile</span>
<span class="sd">    likelihood : bool</span>
<span class="sd">        If True, compute the parameter likelihood</span>
<span class="sd">    mcmc : bool</span>
<span class="sd">        If True, sample the parameter likelihood using an MCMC sampler</span>
<span class="sd">    mcmc_walkers : int</span>
<span class="sd">        Number of MCMC walkers to use in the likelihood</span>
<span class="sd">    like_converge_criteria : float</span>
<span class="sd">        Convergence criteria for likelihood MCMC chains</span>
<span class="sd">    like_tag : str</span>
<span class="sd">        Tag to append to likelihood output file</span>
<span class="sd">    like_lmin : int</span>
<span class="sd">        The minimum ell value to be included in the likelihood calculation</span>
<span class="sd">    like_lmax : int</span>
<span class="sd">        The maximum ell value to be included in the likelihood calculation</span>
<span class="sd">    like_r_specs : list</span>
<span class="sd">        Which spectra to use in the r likelihood.</span>
<span class="sd">    like_template_specs : list</span>
<span class="sd">        Which spectra to use for alpha in the likelihood.</span>
<span class="sd">    like_alpha_tags : list of strings</span>
<span class="sd">        List of map tags from which foreground template maps should be</span>
<span class="sd">        subtracted and fit in the likelihood. If &quot;all&quot;, defaults to</span>
<span class="sd">        template_alpha_tags.  If None, alpha fitting in the likelihood is</span>
<span class="sd">        disabled.</span>
<span class="sd">    alpha_prior: list of floats</span>
<span class="sd">        Flat prior edges for allowed alpha values in the likelihood.</span>
<span class="sd">        Set to None to not fit for alpha values in the likelihood.</span>
<span class="sd">    r_prior: list of floats</span>
<span class="sd">        Flat prior edges for allowed r values in the likelihood.</span>
<span class="sd">    res_prior: list of floats</span>
<span class="sd">        Flat prior edges for allowed qb residual values in the likelihood.</span>
<span class="sd">        Set to None to not fit for residual qb values in the likelihood.</span>
<span class="sd">    like_beam_tags : list of strings</span>
<span class="sd">        List of map tags from which beam error fields are read in to be</span>
<span class="sd">        fit for in the likelihood.  If &quot;all&quot;, then all available map tags</span>
<span class="sd">        in the dataset are included.  If None, then beam error fitting</span>
<span class="sd">        in the likelihood is disabled.</span>
<span class="sd">    beam_prior: list of floats</span>
<span class="sd">        Gaussian prior mean and number of strandard deviations for beam error.</span>
<span class="sd">        This Gaussian is applied as a prior in fitting for beam error in the</span>
<span class="sd">        likelihood. Set to None to not fit for beam error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">version</span>

    <span class="n">all_opts</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>

    <span class="c1"># py3-compatible CPU timer</span>
    <span class="n">cpu_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="s2">&quot;process_time&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="s2">&quot;clock&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
    <span class="n">cpu_start</span> <span class="o">=</span> <span class="n">cpu_time</span><span class="p">()</span>
    <span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">signal_transfer_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signal_transfer_type</span> <span class="o">=</span> <span class="n">signal_type</span>
        <span class="n">all_opts</span><span class="p">[</span><span class="s2">&quot;signal_transfer_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal_transfer_type</span>

    <span class="c1"># make sure sims get rerun correctly</span>
    <span class="k">if</span> <span class="n">signal_transfer_type</span> <span class="o">==</span> <span class="n">signal_type</span><span class="p">:</span>
        <span class="c1"># if signal types match, then sims are run before computing the</span>
        <span class="c1"># transfer function, so need to set the correct checkpoint to rerun</span>
        <span class="k">if</span> <span class="n">checkpoint</span> <span class="o">==</span> <span class="s2">&quot;sims&quot;</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="s2">&quot;sims_transfer&quot;</span>
            <span class="n">all_opts</span><span class="p">[</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">checkpoint</span>

    <span class="k">if</span> <span class="n">template_alpha_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template_alpha_tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">template_alpha</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template_alpha_tags</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">template_alpha</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;template_alpha_tags and template_alpha must be the same length&quot;</span>
        <span class="p">)</span>
    <span class="n">template_alpha</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">template_alpha_tags</span><span class="p">,</span> <span class="n">template_alpha</span><span class="p">))</span>
    <span class="n">all_opts</span><span class="p">[</span><span class="s2">&quot;template_alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">template_alpha</span>
    <span class="n">all_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;template_alpha_tags&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">template_alpha_tags_sim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">template_alpha_sim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">template_alpha_tags_sim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">template_alpha_tags_sim</span> <span class="o">=</span> <span class="n">template_alpha_tags</span>
        <span class="k">if</span> <span class="n">template_alpha_sim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">template_alpha_sim</span> <span class="o">=</span> <span class="p">[</span><span class="n">template_alpha</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">template_alpha_tags</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template_alpha_tags_sim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">template_alpha_sim</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;template_alpha_tags_sim and template_alpha_sim must be the same length&quot;</span>
            <span class="p">)</span>
        <span class="n">template_alpha_sim</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">template_alpha_tags_sim</span><span class="p">,</span> <span class="n">template_alpha_sim</span><span class="p">))</span>
    <span class="n">all_opts</span><span class="p">[</span><span class="s2">&quot;template_alpha_sim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">template_alpha_sim</span>
    <span class="n">all_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;template_alpha_tags_sim&quot;</span><span class="p">)</span>

    <span class="n">sim_index</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="s2">&quot;foreground&quot;</span><span class="p">]:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">all_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;sim_index_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sim_index</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">all_opts</span><span class="p">[</span><span class="s2">&quot;sim_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_index</span>

    <span class="k">if</span> <span class="n">like_alpha_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">like_alpha_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">like_alpha_tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">like_alpha_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">like_alpha_tags</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
    <span class="n">all_opts</span><span class="p">[</span><span class="s2">&quot;like_alpha_tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">like_alpha_tags</span>

    <span class="k">if</span> <span class="n">like_beam_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">like_beam_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">like_beam_tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">like_beam_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">like_beam_tags</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
    <span class="n">all_opts</span><span class="p">[</span><span class="s2">&quot;like_beam_tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">like_beam_tags</span>

    <span class="c1"># initialize config file</span>
    <span class="n">config_vars</span> <span class="o">=</span> <span class="n">xfc</span><span class="o">.</span><span class="n">XFasterConfig</span><span class="p">(</span><span class="n">all_opts</span><span class="p">,</span> <span class="s2">&quot;XFaster General&quot;</span><span class="p">)</span>

    <span class="n">common_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="n">output_root</span><span class="o">=</span><span class="n">output_root</span><span class="p">,</span>
        <span class="n">output_tag</span><span class="o">=</span><span class="n">output_tag</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
        <span class="n">alm_pixel_weights</span><span class="o">=</span><span class="n">alm_pixel_weights</span><span class="p">,</span>
        <span class="n">alm_iter</span><span class="o">=</span><span class="n">alm_iter</span><span class="p">,</span>
        <span class="n">add_log</span><span class="o">=</span><span class="n">add_log</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">common_opts</span><span class="p">,</span> <span class="s2">&quot;XFaster Common&quot;</span><span class="p">)</span>
    <span class="n">common_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>

    <span class="c1"># initialize class</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">xfc</span><span class="o">.</span><span class="n">XFaster</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">common_opts</span><span class="p">)</span>

    <span class="c1"># setup options</span>
    <span class="n">file_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span>
        <span class="n">data_subset</span><span class="o">=</span><span class="n">data_subset</span><span class="p">,</span>
        <span class="n">data_root2</span><span class="o">=</span><span class="n">data_root2</span><span class="p">,</span>
        <span class="n">data_subset2</span><span class="o">=</span><span class="n">data_subset2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_opts</span><span class="p">,</span> <span class="s2">&quot;File Options&quot;</span><span class="p">)</span>

    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Configuring file structure...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
    <span class="n">file_vars</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span><span class="o">**</span><span class="n">file_opts</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_vars</span><span class="p">,</span> <span class="s2">&quot;File Settings&quot;</span><span class="p">)</span>
    <span class="c1"># remove ensemble file arrays from config file</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">file_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;File Settings&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
            <span class="n">config_vars</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;File Settings&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="c1"># disable residual fitting in single map mode</span>
    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">num_maps</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">multi_map</span><span class="p">:</span>
        <span class="n">residual_fit</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">bin_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span>
        <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span>
        <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span>
        <span class="n">pol_mask</span><span class="o">=</span><span class="n">pol_mask</span><span class="p">,</span>
        <span class="n">tbeb</span><span class="o">=</span><span class="n">tbeb</span><span class="p">,</span>
        <span class="n">bin_width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span>
        <span class="n">weighted_bins</span><span class="o">=</span><span class="n">weighted_bins</span><span class="p">,</span>
        <span class="n">residual_fit</span><span class="o">=</span><span class="n">residual_fit</span><span class="p">,</span>
        <span class="n">res_specs</span><span class="o">=</span><span class="n">res_specs</span><span class="p">,</span>
        <span class="n">bin_width_res</span><span class="o">=</span><span class="n">bin_width_res</span><span class="p">,</span>
        <span class="n">foreground_fit</span><span class="o">=</span><span class="n">foreground_fit</span><span class="p">,</span>
        <span class="n">beta_fit</span><span class="o">=</span><span class="n">beta_fit</span><span class="p">,</span>
        <span class="n">bin_width_fg</span><span class="o">=</span><span class="n">bin_width_fg</span><span class="p">,</span>
        <span class="n">lmin_fg</span><span class="o">=</span><span class="n">lmin_fg</span><span class="p">,</span>
        <span class="n">lmax_fg</span><span class="o">=</span><span class="n">lmax_fg</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bin_opts</span><span class="p">,</span> <span class="s2">&quot;Binning Options&quot;</span><span class="p">)</span>

    <span class="n">data_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
        <span class="n">template_type</span><span class="o">=</span><span class="n">template_type</span><span class="p">,</span>
        <span class="n">template_noise_type</span><span class="o">=</span><span class="n">template_noise_type</span><span class="p">,</span>
        <span class="n">template_alpha</span><span class="o">=</span><span class="n">template_alpha</span><span class="p">,</span>
        <span class="n">reference_type</span><span class="o">=</span><span class="n">reference_type</span><span class="p">,</span>
        <span class="n">ensemble_mean</span><span class="o">=</span><span class="n">ensemble_mean</span><span class="p">,</span>
        <span class="n">ensemble_median</span><span class="o">=</span><span class="n">ensemble_median</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">=</span><span class="n">sim_data</span><span class="p">,</span>
        <span class="n">components</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_data</span> <span class="k">else</span> <span class="n">sim_data_components</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_data</span> <span class="k">else</span> <span class="n">sim_index</span><span class="p">,</span>
        <span class="n">num_sims</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_data</span> <span class="k">else</span> <span class="n">num_sims</span><span class="p">,</span>
        <span class="n">signal_type_sim</span><span class="o">=</span><span class="n">signal_type_sim</span> <span class="k">if</span> <span class="n">sim_data_r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span>
        <span class="n">r</span><span class="o">=</span><span class="n">sim_data_r</span><span class="p">,</span>
        <span class="n">noise_type_sim</span><span class="o">=</span><span class="n">noise_type_sim</span><span class="p">,</span>
        <span class="n">qb_file</span><span class="o">=</span><span class="n">qb_file_data</span><span class="p">,</span>
        <span class="n">foreground_type_sim</span><span class="o">=</span><span class="n">foreground_type_sim</span><span class="p">,</span>
        <span class="n">template_type_sim</span><span class="o">=</span><span class="n">template_type_sim</span><span class="p">,</span>
        <span class="n">template_alpha_sim</span><span class="o">=</span><span class="n">template_alpha_sim</span><span class="p">,</span>
        <span class="n">save_sim</span><span class="o">=</span><span class="n">save_sim_data</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data_opts</span><span class="p">,</span> <span class="s2">&quot;Data Construction Options&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;sim_data&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;sim_data_components&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;sim_data_r&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;sim_index&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;qb_file_data&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;save_sim_data&quot;</span><span class="p">)</span>
    <span class="n">data_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;num_sims&quot;</span><span class="p">)</span>

    <span class="n">kernel_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">pixwin</span><span class="o">=</span><span class="n">pixwin</span><span class="p">,</span>
        <span class="n">mask_type</span><span class="o">=</span><span class="n">mask_type</span><span class="p">,</span>
        <span class="n">window_lmax</span><span class="o">=</span><span class="n">window_lmax</span><span class="p">,</span>
        <span class="n">apply_gcorr</span><span class="o">=</span><span class="n">apply_gcorr</span><span class="p">,</span>
        <span class="n">reload_gcorr</span><span class="o">=</span><span class="n">reload_gcorr</span><span class="p">,</span>
        <span class="n">gcorr_file</span><span class="o">=</span><span class="n">gcorr_file</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kernel_opts</span><span class="p">,</span> <span class="s2">&quot;Beam and Kernel Options&quot;</span><span class="p">)</span>

    <span class="n">sim_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">signal_type</span><span class="o">=</span><span class="n">signal_type</span><span class="p">,</span>
        <span class="n">signal_transfer_type</span><span class="o">=</span><span class="n">signal_transfer_type</span><span class="p">,</span>
        <span class="n">signal_subset</span><span class="o">=</span><span class="n">signal_subset</span><span class="p">,</span>
        <span class="n">noise_type</span><span class="o">=</span><span class="n">noise_type</span><span class="p">,</span>
        <span class="n">noise_subset</span><span class="o">=</span><span class="n">noise_subset</span><span class="p">,</span>
        <span class="n">qb_file</span><span class="o">=</span><span class="n">qb_file_sim</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sim_opts</span><span class="p">,</span> <span class="s2">&quot;Simulation Ensemble Options&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;qb_file_sim&quot;</span><span class="p">)</span>
    <span class="n">sim_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;signal_transfer_type&quot;</span><span class="p">)</span>
    <span class="n">sim_transfer_opts</span> <span class="o">=</span> <span class="n">sim_opts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">signal_transfer_type</span> <span class="o">!=</span> <span class="n">signal_type</span><span class="p">:</span>
        <span class="n">sim_transfer_opts</span><span class="p">[</span><span class="s2">&quot;signal_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal_transfer_type</span>
        <span class="n">sim_transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;noise_type&quot;</span><span class="p">)</span>
        <span class="n">sim_transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;noise_subset&quot;</span><span class="p">)</span>
        <span class="n">sim_transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;qb_file&quot;</span><span class="p">)</span>

    <span class="n">shape_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">signal_spec</span><span class="p">,</span>
        <span class="n">filename_transfer</span><span class="o">=</span><span class="n">signal_transfer_spec</span><span class="p">,</span>
        <span class="n">filename_fg</span><span class="o">=</span><span class="n">foreground_spec</span><span class="p">,</span>
        <span class="n">r</span><span class="o">=</span><span class="n">model_r</span><span class="p">,</span>
        <span class="n">freq_ref</span><span class="o">=</span><span class="n">freq_ref</span><span class="p">,</span>
        <span class="n">beta_ref</span><span class="o">=</span><span class="n">beta_ref</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shape_opts</span><span class="p">,</span> <span class="s2">&quot;Shape Spectrum Options&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;signal_spec&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;signal_transfer_spec&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;foreground_spec&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;model_r&quot;</span><span class="p">)</span>
    <span class="n">shape_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;filename_transfer&quot;</span><span class="p">)</span>

    <span class="n">spec_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">multi_map</span><span class="o">=</span><span class="n">multi_map</span><span class="p">,</span>
        <span class="n">converge_criteria</span><span class="o">=</span><span class="n">converge_criteria</span><span class="p">,</span>
        <span class="n">iter_max</span><span class="o">=</span><span class="n">iter_max</span><span class="p">,</span>
        <span class="n">save_iters</span><span class="o">=</span><span class="n">save_iters</span><span class="p">,</span>
        <span class="n">fix_bb_transfer</span><span class="o">=</span><span class="n">fix_bb_transfer</span><span class="p">,</span>
        <span class="n">delta_beta_prior</span><span class="o">=</span><span class="n">delta_beta_prior</span><span class="p">,</span>
        <span class="n">cond_noise</span><span class="o">=</span><span class="n">cond_noise</span><span class="p">,</span>
        <span class="n">cond_criteria</span><span class="o">=</span><span class="n">cond_criteria</span><span class="p">,</span>
        <span class="n">null_first_cmb</span><span class="o">=</span><span class="n">null_first_cmb</span><span class="p">,</span>
        <span class="n">return_cls</span><span class="o">=</span><span class="n">return_cls</span><span class="p">,</span>
        <span class="n">qb_only</span><span class="o">=</span><span class="n">qb_only</span><span class="p">,</span>
        <span class="n">like_profiles</span><span class="o">=</span><span class="n">like_profiles</span><span class="p">,</span>
        <span class="n">like_profile_sigma</span><span class="o">=</span><span class="n">like_profile_sigma</span><span class="p">,</span>
        <span class="n">like_profile_points</span><span class="o">=</span><span class="n">like_profile_points</span><span class="p">,</span>
        <span class="n">file_tag</span><span class="o">=</span><span class="n">bandpower_tag</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">spec_opts</span><span class="p">,</span> <span class="s2">&quot;Spectrum Estimation Options&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;bandpower_tag&quot;</span><span class="p">)</span>
    <span class="n">spec_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;multi_map&quot;</span><span class="p">)</span>
    <span class="n">bandpwr_opts</span> <span class="o">=</span> <span class="n">spec_opts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">bandpwr_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fix_bb_transfer&quot;</span><span class="p">)</span>
    <span class="n">spec_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;file_tag&quot;</span><span class="p">)</span>

    <span class="n">transfer_opts</span> <span class="o">=</span> <span class="n">spec_opts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cond_noise&quot;</span><span class="p">)</span>
    <span class="n">transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cond_criteria&quot;</span><span class="p">)</span>
    <span class="n">transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;delta_beta_prior&quot;</span><span class="p">)</span>
    <span class="n">transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;null_first_cmb&quot;</span><span class="p">)</span>
    <span class="n">transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;return_cls&quot;</span><span class="p">)</span>
    <span class="n">transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;qb_only&quot;</span><span class="p">)</span>
    <span class="n">transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;like_profiles&quot;</span><span class="p">)</span>
    <span class="n">transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;like_profile_sigma&quot;</span><span class="p">)</span>
    <span class="n">transfer_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;like_profile_points&quot;</span><span class="p">)</span>

    <span class="n">like_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">likelihood</span><span class="o">=</span><span class="n">likelihood</span><span class="p">,</span>
        <span class="n">mcmc</span><span class="o">=</span><span class="n">mcmc</span><span class="p">,</span>
        <span class="n">lmin</span><span class="o">=</span><span class="n">like_lmin</span><span class="p">,</span>
        <span class="n">lmax</span><span class="o">=</span><span class="n">like_lmax</span><span class="p">,</span>
        <span class="n">r_specs</span><span class="o">=</span><span class="n">like_r_specs</span><span class="p">,</span>
        <span class="n">template_specs</span><span class="o">=</span><span class="n">like_template_specs</span><span class="p">,</span>
        <span class="n">null_first_cmb</span><span class="o">=</span><span class="n">null_first_cmb</span><span class="p">,</span>
        <span class="n">alpha_tags</span><span class="o">=</span><span class="n">like_alpha_tags</span><span class="p">,</span>
        <span class="n">alpha_prior</span><span class="o">=</span><span class="n">alpha_prior</span><span class="p">,</span>
        <span class="n">r_prior</span><span class="o">=</span><span class="n">r_prior</span><span class="p">,</span>
        <span class="n">res_prior</span><span class="o">=</span><span class="n">res_prior</span><span class="p">,</span>
        <span class="n">beam_tags</span><span class="o">=</span><span class="n">like_beam_tags</span><span class="p">,</span>
        <span class="n">beam_prior</span><span class="o">=</span><span class="n">beam_prior</span><span class="p">,</span>
        <span class="n">num_walkers</span><span class="o">=</span><span class="n">mcmc_walkers</span><span class="p">,</span>
        <span class="n">converge_criteria</span><span class="o">=</span><span class="n">like_converge_criteria</span><span class="p">,</span>
        <span class="n">file_tag</span><span class="o">=</span><span class="n">like_tag</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">like_opts</span><span class="p">,</span> <span class="s2">&quot;Likelihood Estimation Options&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;like_lmin&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;like_lmax&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;like_r_specs&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;like_template_specs&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;mcmc_walkers&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;like_converge_criteria&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;like_tag&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;like_alpha_tags&quot;</span><span class="p">)</span>
    <span class="n">config_vars</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="s2">&quot;XFaster General&quot;</span><span class="p">,</span> <span class="s2">&quot;like_beam_tags&quot;</span><span class="p">)</span>
    <span class="n">like_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;likelihood&quot;</span><span class="p">)</span>

    <span class="c1"># store config</span>
    <span class="n">X</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">config_vars</span><span class="p">)</span>

    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Setting up bin definitions...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">get_bin_def</span><span class="p">(</span><span class="o">**</span><span class="n">bin_opts</span><span class="p">)</span>

    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing mask cross-spectra and weights...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">get_mask_weights</span><span class="p">(</span>
        <span class="n">mask_type</span><span class="o">=</span><span class="n">mask_type</span><span class="p">,</span>
        <span class="n">apply_gcorr</span><span class="o">=</span><span class="n">apply_gcorr</span><span class="p">,</span>
        <span class="n">reload_gcorr</span><span class="o">=</span><span class="n">reload_gcorr</span><span class="p">,</span>
        <span class="n">gcorr_file</span><span class="o">=</span><span class="n">gcorr_file</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing kernels...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">get_kernels</span><span class="p">(</span><span class="n">window_lmax</span><span class="o">=</span><span class="n">window_lmax</span><span class="p">)</span>

    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing beam window functions...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">get_beams</span><span class="p">(</span><span class="n">pixwin</span><span class="o">=</span><span class="n">pixwin</span><span class="p">)</span>

    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing sim ensemble averages for transfer function...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">get_masked_sims</span><span class="p">(</span><span class="n">transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">sim_transfer_opts</span><span class="p">)</span>

    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Loading spectrum shape for transfer function...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">get_signal_shape</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">signal_transfer_spec</span><span class="p">,</span> <span class="n">transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing transfer functions...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="o">**</span><span class="n">transfer_opts</span><span class="p">)</span>

    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing sim ensemble averages...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">get_masked_sims</span><span class="p">(</span><span class="o">**</span><span class="n">sim_opts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">null_run</span><span class="p">:</span>
        <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Loading flat spectrum for null test...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">get_signal_shape</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Loading spectrum shape for bandpowers...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">get_signal_shape</span><span class="p">(</span><span class="o">**</span><span class="n">shape_opts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sim_data</span><span class="p">:</span>
        <span class="n">idx0</span> <span class="o">=</span> <span class="n">data_opts</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_sims</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">idx0</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">bperr</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx0</span><span class="p">,</span> <span class="n">idx0</span> <span class="o">+</span> <span class="n">num_sims</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sim_data</span><span class="p">:</span>
            <span class="n">data_opts</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;Computing masked </span><span class="si">{}</span><span class="s2"> cross-spectra...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;simulated data index </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">if</span> <span class="n">sim_data</span> <span class="k">else</span> <span class="s2">&quot;data&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;notice&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">get_masked_data</span><span class="p">(</span><span class="o">**</span><span class="n">data_opts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">multi_map</span><span class="p">:</span>
            <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing multi-map bandpowers...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">qb</span><span class="p">,</span> <span class="n">inv_fish</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_bandpowers</span><span class="p">(</span><span class="n">return_qb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">bandpwr_opts</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">bperr</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
                <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing multi-map likelihood...&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">get_likelihood</span><span class="p">(</span><span class="n">qb</span><span class="p">,</span> <span class="n">inv_fish</span><span class="p">,</span> <span class="o">**</span><span class="n">like_opts</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">map_tag</span><span class="p">,</span> <span class="n">map_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">map_tags</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">map_files</span><span class="p">):</span>
                <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Processing map </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">map_tag</span><span class="p">,</span> <span class="n">map_file</span><span class="p">),</span> <span class="s2">&quot;notice&quot;</span><span class="p">)</span>

                <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing bandpowers for map </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">map_tag</span><span class="p">),</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">qb</span><span class="p">,</span> <span class="n">inv_fish</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_bandpowers</span><span class="p">(</span>
                        <span class="n">map_tag</span><span class="o">=</span><span class="n">map_tag</span><span class="p">,</span> <span class="n">return_qb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">bandpwr_opts</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="n">bperr</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
                    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Computing likelihoods for map </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">map_tag</span><span class="p">),</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>
                    <span class="n">X</span><span class="o">.</span><span class="n">get_likelihood</span><span class="p">(</span><span class="n">qb</span><span class="p">,</span> <span class="n">inv_fish</span><span class="p">,</span> <span class="n">map_tag</span><span class="o">=</span><span class="n">map_tag</span><span class="p">,</span> <span class="o">**</span><span class="n">like_opts</span><span class="p">)</span>

    <span class="n">cpu_elapsed</span> <span class="o">=</span> <span class="n">cpu_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">cpu_start</span>
    <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_start</span>
    <span class="n">X</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="s2">&quot;Wall time: </span><span class="si">{:.2f}</span><span class="s2"> s, CPU time: </span><span class="si">{:.2f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_elapsed</span><span class="p">,</span> <span class="n">cpu_elapsed</span><span class="p">),</span>
        <span class="s2">&quot;notice&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">bperr</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Caught error(s) computing bandpowers, check logs.&quot;</span><span class="p">)</span></div>


<span class="n">xfaster_run</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">xfaster_run</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">checkpoints</span><span class="o">=</span><span class="n">xfc</span><span class="o">.</span><span class="n">XFaster</span><span class="o">.</span><span class="n">checkpoints</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_func_defaults</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a dictionary containing the default values for each keyword</span>
<span class="sd">    argument of the given function</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    func : function or callable</span>
<span class="sd">        This function&#39;s keyword arguments will be extracted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict of kwargs and their default values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

    <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="o">!=</span> <span class="n">p</span><span class="o">.</span><span class="n">empty</span><span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">extract_func_kwargs</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">pop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">others_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract arguments for a given function from a kwargs dictionary</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    func : function or callable</span>
<span class="sd">        This function&#39;s keyword arguments will be extracted.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Dictionary of keyword arguments from which to extract.</span>
<span class="sd">        NOTE: pass the ``kwargs`` dict itself, not ``**kwargs``</span>
<span class="sd">    pop : bool, optional</span>
<span class="sd">        Whether to pop matching arguments from kwargs.</span>
<span class="sd">    others_ok : bool</span>
<span class="sd">        If False, an exception will be raised when kwargs contains keys</span>
<span class="sd">        that are not keyword arguments of func.</span>
<span class="sd">    warn : bool</span>
<span class="sd">        If True, a warning is issued when kwargs contains keys that are not</span>
<span class="sd">        keyword arguments of func.  Use with ``others_ok=True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Dict of items from kwargs for which func has matching keyword arguments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="o">!=</span> <span class="n">p</span><span class="o">.</span><span class="n">empty</span><span class="p">]</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pop</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">others_ok</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Found invalid keyword argument: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">warn</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Ignoring invalid keyword arguments: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="ne">Warning</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>


<div class="viewcode-block" id="xfaster_parse"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.xfaster_parse">[docs]</a><span class="k">def</span> <span class="nf">xfaster_parse</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a parsed dictionary of arguments for the xfaster execution script.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    args : list of strings, optional</span>
<span class="sd">        If not supplied, read from the command line (sys.argv) by argparse.</span>
<span class="sd">    test : bool, optional</span>
<span class="sd">        If True, raise a RuntimeError instead of exiting.  Useful for</span>
<span class="sd">        interactive testing.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    args : dict</span>
<span class="sd">        Dictionary of parsed options</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">argparse</span> <span class="k">as</span> <span class="nn">ap</span>
    <span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">version</span>

    <span class="n">parser_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the XFaster algorithm&quot;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">ap</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># initialize parser</span>
    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>

        <span class="k">class</span> <span class="nc">TestParser</span><span class="p">(</span><span class="n">ap</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">TestParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_usage</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;exiting with status </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">status</span><span class="p">,</span> <span class="s2">&quot;: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">TestParser</span><span class="p">(</span><span class="o">**</span><span class="n">parser_opts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="o">**</span><span class="n">parser_opts</span><span class="p">)</span>

    <span class="c1"># add --version option</span>
    <span class="n">P</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(prog)s</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="n">version</span><span class="p">)</span>

    <span class="c1"># get default argument values from xfaster_run</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">get_func_defaults</span><span class="p">(</span><span class="n">xfaster_run</span><span class="p">)</span>
    <span class="n">defaults</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;add_log&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">rem_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>

    <span class="c1"># argument docstrings</span>
    <span class="n">docstr</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="n">xfaster_run</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">arg_docs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">argdoc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">docstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;    &quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">argdoc</span><span class="p">:</span>
                <span class="n">argdoc</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>
            <span class="n">argdoc</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">argdoc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;If True, &quot;</span><span class="p">):</span>
                        <span class="n">argdoc</span> <span class="o">=</span> <span class="n">argdoc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s2">&quot;If True, &quot;</span><span class="p">,</span>
                            <span class="s2">&quot;If </span><span class="si">{}</span><span class="s2">set, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;not &quot;</span> <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">argdoc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;If False, &quot;</span><span class="p">):</span>
                        <span class="n">argdoc</span> <span class="o">=</span> <span class="n">argdoc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s2">&quot;If False, &quot;</span><span class="p">,</span>
                            <span class="s2">&quot;If </span><span class="si">{}</span><span class="s2">set, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;not &quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">defaults</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
                <span class="n">arg_docs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">argdoc</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">argdoc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">add_arg</span><span class="p">(</span>
        <span class="n">P</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">argtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">short</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">positional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for populating command line arguments. Wrapper</span>
<span class="sd">        for ArgumentParser.add_argument.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        P : argument parser instance</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of argument to add</span>
<span class="sd">        argtype : str</span>
<span class="sd">            Data type of argument</span>
<span class="sd">        default : arb</span>
<span class="sd">            Default value of the argument</span>
<span class="sd">        short : str</span>
<span class="sd">            Shortened name of argument</span>
<span class="sd">        help : str</span>
<span class="sd">            Description of argument</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">help</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">arg_docs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">positional</span><span class="p">:</span>
            <span class="n">argname</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">argname</span> <span class="o">=</span> <span class="s2">&quot;--</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>
        <span class="n">altname</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;altname&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rem_args</span><span class="p">:</span>
            <span class="n">rem_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">help</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing help text for argument </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="n">opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">positional</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">argname</span> <span class="o">=</span> <span class="s2">&quot;--no-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>
            <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;store_false&quot;</span>
        <span class="k">elif</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;store_true&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="s2">&quot;store_false&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">argtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                        <span class="n">argtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
                <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argtype</span>

        <span class="n">argnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">argname</span><span class="p">,)</span>
        <span class="k">if</span> <span class="n">short</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">short</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">short</span> <span class="o">=</span> <span class="s2">&quot;-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">short</span><span class="p">)</span>
            <span class="n">argnames</span> <span class="o">+=</span> <span class="p">(</span><span class="n">short</span><span class="p">,)</span>
        <span class="k">if</span> <span class="n">altname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">argnames</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;--</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">altname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)),)</span>

        <span class="n">P</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="o">*</span><span class="n">argnames</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

    <span class="c1"># subparsers</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;MODE&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;subcommands&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Function to perform. For more help, call: </span><span class="si">%(prog)s</span><span class="s2"> </span><span class="si">%(metavar)s</span><span class="s2"> -h&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>

    <span class="c1"># populate subparsers</span>
    <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">helptext</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;run xfaster&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="s2">&quot;submit xfaster job&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dump&quot;</span><span class="p">,</span> <span class="s2">&quot;dump archive from xfaster job to stdout&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;compare two archive files&quot;</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="n">PP</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">helptext</span><span class="p">,</span> <span class="o">**</span><span class="n">parser_opts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;dump&quot;</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">add_arg</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;output_file&quot;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Archive filename to print&quot;</span><span class="p">)</span>
            <span class="n">add_arg</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;output_root&quot;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-r&quot;</span><span class="p">)</span>
            <span class="n">add_arg</span><span class="p">(</span><span class="n">PP</span><span class="p">,</span> <span class="s2">&quot;output_tag&quot;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-t&quot;</span><span class="p">)</span>
            <span class="n">add_arg</span><span class="p">(</span>
                <span class="n">PP</span><span class="p">,</span>
                <span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span>
                <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="n">xfc</span><span class="o">.</span><span class="n">XFaster</span><span class="o">.</span><span class="n">checkpoints</span><span class="p">,</span>
                <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;CHECKPOINT&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print all files for this checkpoint&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">add_arg</span><span class="p">(</span>
                <span class="n">PP</span><span class="p">,</span>
                <span class="s2">&quot;keys&quot;</span><span class="p">,</span>
                <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-k&quot;</span><span class="p">,</span>
                <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select keys to print from each file&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">add_arg</span><span class="p">(</span>
                <span class="n">PP</span><span class="p">,</span>
                <span class="s2">&quot;verbose&quot;</span><span class="p">,</span>
                <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print complete entries&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;diff&quot;</span><span class="p">:</span>
            <span class="n">add_arg</span><span class="p">(</span><span class="n">PP</span><span class="p">,</span> <span class="s2">&quot;file1&quot;</span><span class="p">,</span> <span class="n">positional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File to compare&quot;</span><span class="p">)</span>
            <span class="n">add_arg</span><span class="p">(</span><span class="n">PP</span><span class="p">,</span> <span class="s2">&quot;file2&quot;</span><span class="p">,</span> <span class="n">positional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File to compare&quot;</span><span class="p">)</span>
            <span class="n">add_arg</span><span class="p">(</span>
                <span class="n">PP</span><span class="p">,</span>
                <span class="s2">&quot;keys&quot;</span><span class="p">,</span>
                <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-k&quot;</span><span class="p">,</span>
                <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select keys to print from each file&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">add_arg</span><span class="p">(</span>
                <span class="n">PP</span><span class="p">,</span>
                <span class="s2">&quot;verbose&quot;</span><span class="p">,</span>
                <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print status of all entries&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># common options</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;common options&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;output_root&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;output_tag&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span>
            <span class="s2">&quot;verbose&quot;</span><span class="p">,</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;notice&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">],</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;LEVEL&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span>
            <span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span>
            <span class="n">short</span><span class="o">=</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">xfc</span><span class="o">.</span><span class="n">XFaster</span><span class="o">.</span><span class="n">checkpoints</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;CHECKPOINT&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;alm_pixel_weights&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;alm_iter&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># file options</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;file options&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;data_root&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;data_subset&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;data_root2&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;data_subset2&quot;</span><span class="p">)</span>

        <span class="c1"># binning options</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;binning options&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;lmin&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;lmax&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Ignore polarization&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;pol_mask&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use the same mask for Q/U maps as for T maps&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;tbeb&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;bin_width&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;weighted_bins&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;residual_fit&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;bin_width_res&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span>
            <span class="s2">&quot;res_specs&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TT&quot;</span><span class="p">,</span> <span class="s2">&quot;EE&quot;</span><span class="p">,</span> <span class="s2">&quot;BB&quot;</span><span class="p">,</span> <span class="s2">&quot;TE&quot;</span><span class="p">,</span> <span class="s2">&quot;EB&quot;</span><span class="p">,</span> <span class="s2">&quot;TB&quot;</span><span class="p">,</span> <span class="s2">&quot;EEBB&quot;</span><span class="p">],</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;SPEC&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;foreground_fit&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;beta_fit&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;bin_width_fg&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;lmin_fg&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;lmax_fg&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># beam and kernel options</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;beam and kernel options&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;pixwin&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;mask_type&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;window_lmax&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;apply_gcorr&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;reload_gcorr&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;gcorr_file&quot;</span><span class="p">)</span>

        <span class="c1"># sim ensemble options</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;sim ensemble options&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;signal_type&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;signal_subset&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;signal_transfer_type&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;noise_type&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;noise_subset&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;qb_file_sim&quot;</span><span class="p">)</span>

        <span class="c1"># shape spectrum options</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;shape spectrum options&quot;</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;signal_spec&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;model_r&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;signal_transfer_spec&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;foreground_spec&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;freq_ref&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;beta_ref&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># data options</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;data options&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;data_type&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;template_type&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;template_noise_type&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;template_alpha_tags&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TAG&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;template_alpha&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;reference_type&quot;</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;ensemble_mean&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;ensemble_median&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;sim_data&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span>
            <span class="s2">&quot;sim_data_components&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="s2">&quot;foreground&quot;</span><span class="p">,</span> <span class="s2">&quot;template&quot;</span><span class="p">],</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;COMP&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;sim_index_default&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;num_sims&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;sim_index_signal&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;sim_index_noise&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;sim_index_foreground&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;signal_type_sim&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;sim_data_r&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;noise_type_sim&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;qb_file_data&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;foreground_type_sim&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;template_type_sim&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;template_alpha_tags_sim&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TAG&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;template_alpha_sim&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;save_sim_data&quot;</span><span class="p">)</span>

        <span class="c1"># spectrum estimation options</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;spectrum estimation options&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;multi_map&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;bandpower_tag&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;converge_criteria&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;cond_noise&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;cond_criteria&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;iter_max&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;save_iters&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;return_cls&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;qb_only&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;fix_bb_transfer&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;null_first_cmb&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;delta_beta_prior&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;like_profiles&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;like_profile_sigma&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;like_profile_points&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;likelihood options&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;likelihood&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;mcmc&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;mcmc_walkers&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;like_converge_criteria&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;like_tag&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;like_lmin&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;like_lmax&quot;</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span>
            <span class="s2">&quot;like_r_specs&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TT&quot;</span><span class="p">,</span> <span class="s2">&quot;EE&quot;</span><span class="p">,</span> <span class="s2">&quot;BB&quot;</span><span class="p">,</span> <span class="s2">&quot;TE&quot;</span><span class="p">,</span> <span class="s2">&quot;EB&quot;</span><span class="p">,</span> <span class="s2">&quot;TB&quot;</span><span class="p">],</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;SPEC&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span>
            <span class="s2">&quot;like_template_specs&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TT&quot;</span><span class="p">,</span> <span class="s2">&quot;EE&quot;</span><span class="p">,</span> <span class="s2">&quot;BB&quot;</span><span class="p">,</span> <span class="s2">&quot;TE&quot;</span><span class="p">,</span> <span class="s2">&quot;EB&quot;</span><span class="p">,</span> <span class="s2">&quot;TB&quot;</span><span class="p">],</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;SPEC&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;like_alpha_tags&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TAG&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;alpha_prior&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;r_prior&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;res_prior&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;like_beam_tags&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TAG&quot;</span><span class="p">)</span>
        <span class="n">add_arg</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;beam_prior&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># submit args</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;submit&quot;</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">PP</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;submit options&quot;</span><span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--job-prefix&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name to prefix to all submitted jobs&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;--queue&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Queue to submit to&quot;</span>
            <span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--nodes&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of nodes to use. Or node name&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--ppn&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of processors per node&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--mem&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Memory per process, in GB&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
            <span class="n">E</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--cput&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;cput per process in hours&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">E</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--wallt&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;walltime in hours&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--nice&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Scheduling priority from -5000 (high) to 5000&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--omp-threads&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of OMP threads to use&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--slurm&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Submit a slurm script rather than PBS&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--env-script&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Script to source in jobs to set up environment&quot;</span>
            <span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--exclude&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Nodes to exclude&quot;</span><span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--dep-afterok&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of job IDs to wait on completion of before running job&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># other arguments</span>
        <span class="n">PP</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--test&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print options for debugging&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># check that all xfaster_run arguments have been handled by the parser</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rem_args</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Argument(s) </span><span class="si">{}</span><span class="s2"> not handled by the parser&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rem_args</span><span class="p">),</span>
            <span class="n">xfc</span><span class="o">.</span><span class="n">XFasterWarning</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># parse arguments</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># default mode, required for python 3.7 or newer</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">P</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;the following arguments are required: MODE&quot;</span><span class="p">)</span>

    <span class="c1"># fix arguments meant to be empty</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># test mode</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="s2">&quot;dump&quot;</span><span class="p">,</span> <span class="s2">&quot;diff&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="n">P</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">argument test</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">)</span>

    <span class="c1"># return a dictionary</span>
    <span class="k">return</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="XFasterJobGroup"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.XFasterJobGroup">[docs]</a><span class="k">class</span> <span class="nc">XFasterJobGroup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class for parsing xfaster options into a job script, and optionally</span>
<span class="sd">        grouping the jobs together.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<div class="viewcode-block" id="XFasterJobGroup.reset"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.XFasterJobGroup.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize to a reset state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub_args</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="XFasterJobGroup.add_job"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.XFasterJobGroup.add_job">[docs]</a>    <span class="k">def</span> <span class="nf">add_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add xfaster job to script.</span>

<span class="sd">        Keyword arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        Most should correspond to arguments accepted by ``xfaster_run``.</span>
<span class="sd">        If job-related arguments are present, they will be passed to</span>
<span class="sd">        ``set_job_options``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># set job options</span>
        <span class="n">job_opts</span> <span class="o">=</span> <span class="n">extract_func_kwargs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_job_options</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">pop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">others_ok</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># ensure absolute paths for submit</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;data_root&quot;</span><span class="p">,</span> <span class="s2">&quot;data_root2&quot;</span><span class="p">,</span> <span class="s2">&quot;output_root&quot;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">output_root</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_root&quot;</span><span class="p">)</span>
        <span class="n">output_tag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_tag&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">output_tag</span><span class="p">)</span>
            <span class="n">job_opts</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_root</span>

        <span class="k">if</span> <span class="n">job_opts</span><span class="p">:</span>
            <span class="n">job_prefix</span> <span class="o">=</span> <span class="n">job_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;job_prefix&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job_prefix</span> <span class="o">=</span> <span class="s2">&quot;xfaster&quot;</span>
                <span class="k">if</span> <span class="n">output_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_prefix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">job_prefix</span><span class="p">,</span> <span class="n">output_tag</span><span class="p">])</span>
                <span class="n">job_opts</span><span class="p">[</span><span class="s2">&quot;job_prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_prefix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_job_options</span><span class="p">(</span><span class="o">**</span><span class="n">job_opts</span><span class="p">)</span>

        <span class="c1"># construct command</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;xfaster run&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1"># figure out variable types from default values</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">get_func_defaults</span><span class="p">(</span><span class="n">xfaster_run</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

            <span class="n">da</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">da</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--no-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">da</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">da</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;template_alpha_tags&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;template_alpha&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;template_alpha_tags_sim&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;template_alpha_sim&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;res_specs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;like_mask&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;r_prior&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;like_alpha_tags&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;alpha_prior&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;like_beam_tags&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;beam_prior&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;res_prior&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;like_r_specs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;like_template_specs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sim_data_components&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;bin_width&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;bin_width_res&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;bin_width_fg&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s2">&quot;prior&quot;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                        <span class="c1"># special case to allow -inf to work</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;&#39; </span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>

                <span class="k">elif</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;noise_subset&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;signal_subset&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;data_subset&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;data_subset2&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="c1"># add quotes around glob parseable args to avoid weird</span>
                    <span class="c1"># behavior</span>
                    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Args that are not being parsed-- raise an error</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> arguments not recognized.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="XFasterJobGroup.set_job_options"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.XFasterJobGroup.set_job_options">[docs]</a>    <span class="k">def</span> <span class="nf">set_job_options</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wallt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ppn</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">nodes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">mem</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">env_script</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">omp_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nice</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">job_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">pbs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dep_afterok</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse options that control the job script, rather than xfaster.</span>
<span class="sd">        Passed to batch_tools.batch_sub.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        output : string, optional</span>
<span class="sd">            Path for output scheduler files, in a logs subdirectory.</span>
<span class="sd">            If None, use output_root. Overrided by workdir.</span>
<span class="sd">        workdir : string, optional</span>
<span class="sd">            If not None, path to output scheduler files. Overrides output.</span>
<span class="sd">        cput : string or float or datetime.timedelta, optional</span>
<span class="sd">            Amount of CPU time requested.</span>
<span class="sd">            String values should be in the format HH:MM:SS, e.g. &#39;10:00:00&#39;.</span>
<span class="sd">            Numerical values are interpreted as a number of hours.</span>
<span class="sd">        wallt : string or float or datetime.timedelta, optional</span>
<span class="sd">            Amount of wall clock time requested.</span>
<span class="sd">            String values should be in the format HH:MM:SS, e.g. &#39;10:00:00&#39;.</span>
<span class="sd">            Numerical values are interpreted as a number of hours.</span>
<span class="sd">        ppn : int, optional</span>
<span class="sd">            Numper of processes per node</span>
<span class="sd">        nodes : int or string, optional</span>
<span class="sd">            Number of nodes to use in job</span>
<span class="sd">            If a string, will be passed as-is to PBS -l node= resource</span>
<span class="sd">            If using SLURM and a string, will overwrite node_list if None</span>
<span class="sd">        mem : float or string, optional</span>
<span class="sd">            Amount of memory to request for the job. float values in GB.</span>
<span class="sd">            Or pass a string (eg &#39;4gb&#39;) to use directly.</span>
<span class="sd">        env_script : string, optional</span>
<span class="sd">            Path to script to source during job script preamble</span>
<span class="sd">            For loading modules, setting environment variables, etc</span>
<span class="sd">        omp_threads : int, optional</span>
<span class="sd">            Number of OpenMP threads to use per process</span>
<span class="sd">        nice : int, optional</span>
<span class="sd">            Adjust scheduling priority (SLURM only). Range from -5000 (highest</span>
<span class="sd">            priority) to 5000 (lowest priority).</span>
<span class="sd">            Note: actual submitted --nice value is 5000 higher, since negative</span>
<span class="sd">            values require special privilege.</span>
<span class="sd">        queue : string, optional</span>
<span class="sd">            The name of the queue to which to submit jobs</span>
<span class="sd">        job_prefix : string, optional</span>
<span class="sd">            The name of the job. Default: xfaster</span>
<span class="sd">        test : bool</span>
<span class="sd">            If True, only print out the job submission script, don&#39;t submit it.</span>
<span class="sd">        pbs : bool</span>
<span class="sd">            If True, use pbs scheduler. Else, use slurm.</span>
<span class="sd">        dep_afterok : string or list of strings</span>
<span class="sd">            Dependency. Job ID (or IDs) on which to wait for successful completion,</span>
<span class="sd">            before starting this job</span>
<span class="sd">        exclude : string or list of strings</span>
<span class="sd">            List of nodes that will be excluded for job. SLURM-only.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># XFaster runs faster with OMP</span>
        <span class="k">if</span> <span class="n">omp_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">omp_threads</span> <span class="o">=</span> <span class="n">ppn</span>

        <span class="c1"># default job prefix</span>
        <span class="k">if</span> <span class="n">job_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_prefix</span> <span class="o">=</span> <span class="s2">&quot;xfaster&quot;</span>

        <span class="c1"># create output directories</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cput</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># split at &quot;:&quot; since extra resource modifiers can go after</span>
                <span class="n">cput</span> <span class="o">*=</span> <span class="n">ppn</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># could not convert nodes to int, assume one node (name)</span>
                <span class="n">cput</span> <span class="o">*=</span> <span class="n">ppn</span>
        <span class="k">if</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mem</span> <span class="o">*=</span> <span class="n">ppn</span>

        <span class="n">scheduler</span> <span class="o">=</span> <span class="s2">&quot;slurm&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span>
            <span class="n">mem</span><span class="o">=</span><span class="n">mem</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span>
            <span class="n">ppn</span><span class="o">=</span><span class="n">ppn</span><span class="p">,</span>
            <span class="n">cput</span><span class="o">=</span><span class="n">cput</span><span class="p">,</span>
            <span class="n">wallt</span><span class="o">=</span><span class="n">wallt</span><span class="p">,</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
            <span class="n">env_script</span><span class="o">=</span><span class="n">env_script</span><span class="p">,</span>
            <span class="n">omp_threads</span><span class="o">=</span><span class="n">omp_threads</span><span class="p">,</span>
            <span class="n">nice</span><span class="o">=</span><span class="n">nice</span><span class="p">,</span>
            <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">submit</span><span class="o">=</span><span class="ow">not</span> <span class="n">test</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">job_prefix</span><span class="p">,</span>
            <span class="n">dep_afterok</span><span class="o">=</span><span class="n">dep_afterok</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="XFasterJobGroup.submit"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.XFasterJobGroup.submit">[docs]</a>    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit jobs that have been added.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        group_by : int, optional</span>
<span class="sd">            Group xfaster calls into jobs with this many calls each.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Print the working directory, and the job ID if submitted successfully.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        job_ids : list of strings</span>
<span class="sd">            The IDs of the submitted jobs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No xfaster jobs have been added.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_by</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_job_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_args</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No job options specified&quot;</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">batch_group</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="p">,</span>
            <span class="n">group_by</span><span class="o">=</span><span class="n">group_by</span><span class="p">,</span>
            <span class="n">serial</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_args</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">job_ids</span></div></div>


<div class="viewcode-block" id="xfaster_submit"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.xfaster_submit">[docs]</a><span class="k">def</span> <span class="nf">xfaster_submit</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Submit a single xfaster job. The arguments here should agree exactly</span>
<span class="sd">    with the command line flags for submit mode, with kwargs passed to</span>
<span class="sd">    ``xfaster_run``. Run ``xfaster --help`` for help.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xg</span> <span class="o">=</span> <span class="n">XFasterJobGroup</span><span class="p">()</span>
    <span class="n">xg</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xg</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">group_by</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="xfaster_dump"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.xfaster_dump">[docs]</a><span class="k">def</span> <span class="nf">xfaster_dump</span><span class="p">(</span>
    <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the contents of a set of output archive files.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to an output npz archive file.</span>
<span class="sd">    output_root : str</span>
<span class="sd">        Path to an xfaster output directory containing npz archive files.</span>
<span class="sd">        Ignored if ``output_file`` is set.</span>
<span class="sd">    output_tag : str</span>
<span class="sd">        Optional file tag.  Ignored if ``output_file`` is set.</span>
<span class="sd">    checkpoint : str</span>
<span class="sd">        Checkpoint for which to print all matching archive files.  Ignored if</span>
<span class="sd">        ``output_file`` is set.</span>
<span class="sd">    keys : list of str</span>
<span class="sd">        List of keys to print for each matching archive file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        If True, print the entire contents of the dictionary.  Otherwise,</span>
<span class="sd">        truncate each entry to a single line.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">output_root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">output_file</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">output_tag</span><span class="p">)</span>
            <span class="n">output_tag</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="s2">&quot;*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="s2">&quot;files*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;masks&quot;</span><span class="p">:</span> <span class="s2">&quot;masks_xcorr*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;kernels&quot;</span><span class="p">:</span> <span class="s2">&quot;kernels*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;sims_transfer&quot;</span><span class="p">:</span> <span class="s2">&quot;simx_xcorr*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;shape_transfer&quot;</span><span class="p">:</span> <span class="s2">&quot;shape_transfer*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;transfer&quot;</span><span class="p">:</span> <span class="s2">&quot;transfer_all*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;sims&quot;</span><span class="p">:</span> <span class="s2">&quot;sims_xcorr*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;beams&quot;</span><span class="p">:</span> <span class="s2">&quot;beams</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data*xcorr*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;sim_data&quot;</span><span class="p">:</span> <span class="s2">&quot;sim_data*xcorr*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;template_noise&quot;</span><span class="p">:</span> <span class="s2">&quot;template_noise*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s2">&quot;shape*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;bandpowers&quot;</span><span class="p">:</span> <span class="s2">&quot;bandpowers*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;beam_errors&quot;</span><span class="p">:</span> <span class="s2">&quot;beam_errors*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
            <span class="s2">&quot;likelihood&quot;</span><span class="p">:</span> <span class="s2">&quot;like_mcmc*</span><span class="si">{}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_tag</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">patterns</span><span class="p">[</span><span class="n">checkpoint</span><span class="p">])))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="s2">&quot;No files found for checkpoint </span><span class="si">{}</span><span class="s2"> in directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">checkpoint</span><span class="p">,</span> <span class="n">output_root</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">load_and_parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***** </span><span class="si">{}</span><span class="s2"> *****&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">txt</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span>
                            <span class="n">txt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;shape </span><span class="si">{}</span><span class="s2"> array of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; ...&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    &#39;</span><span class="si">{}</span><span class="s2">&#39;: </span><span class="si">{}</span><span class="s2">,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">txt</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">xfaster_diff</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare two output archive files to each other.  Uses setdiff or numpy.diff</span>
<span class="sd">    as appropriate.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    file1 : str</span>
<span class="sd">    file2 : str</span>
<span class="sd">        Filenames to compare to each other</span>
<span class="sd">    keys : list of str</span>
<span class="sd">        List of keys to compare between files</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        If True, print the status of all keys, even if identical.  Otherwise,</span>
<span class="sd">        only print the status for keys that do not match between files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">load1</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">load_and_parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span> <span class="o">=</span> <span class="p">[</span><span class="n">load1</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="n">d1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">d1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d1</span> <span class="o">!=</span> <span class="n">d2</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2"> != </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> SAME: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">d1</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">d1</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">]:</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                <span class="n">sd</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">-</span> <span class="n">s2</span>
                <span class="k">if</span> <span class="n">sd</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">only in </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">file1</span><span class="p">,</span> <span class="n">sd</span><span class="p">))</span>
                <span class="n">sd</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">-</span> <span class="n">s1</span>
                <span class="k">if</span> <span class="n">sd</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">only in </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">file2</span><span class="p">,</span> <span class="n">sd</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s1</span> <span class="o">^</span> <span class="n">s2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">SAME&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">d2</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">ALL CLOSE&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">d2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">: only in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">file2</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">: only in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">file1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">compare</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: parser error: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">),</span> <span class="n">d1</span><span class="p">))</span>

    <span class="n">compare</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>


<div class="viewcode-block" id="xfaster_main"><a class="viewcode-back" href="../../api.html#xfaster.xfaster_exec.xfaster_main">[docs]</a><span class="k">def</span> <span class="nf">xfaster_main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point for command-line interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># parse arguments</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">xfaster_parse</span><span class="p">()</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;submit&quot;</span><span class="p">:</span>
        <span class="c1"># submit a job</span>
        <span class="n">xfaster_submit</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
        <span class="c1"># run the analysis</span>
        <span class="n">xfaster_run</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;dump&quot;</span><span class="p">:</span>
        <span class="c1"># dump archive files to stdout</span>
        <span class="n">xfaster_dump</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;diff&quot;</span><span class="p">:</span>
        <span class="c1"># diff archive files</span>
        <span class="n">xfaster_diff</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, A. Gambrel, A. Rahlin, C. Contaldi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>